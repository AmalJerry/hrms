<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Branch Locations</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 30px;
      background: #f4f6f9;
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
    }
    .btn {
      padding: 8px 16px;
      text-decoration: none;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    .btn-primary {
      background-color: #007bff;
      color: white;
    }
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    .btn-edit {
      background-color: #28a745;
      color: white;
    }
    .add-btn {
      float: right;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #343a40;
      color: white;
    }
    .map-preview {
      height: 150px;
      width: 100%;
      border: 1px solid #ccc;
    }
  </style>
  <script>
    function initMap() {
      {% for branch in branches %}
      const map{{ forloop.counter }} = new google.maps.Map(document.getElementById("map{{ forloop.counter }}"), {
        center: { lat: {{ branch.lat }}, lng: {{ branch.lon }} },
        zoom: 15
      });
      new google.maps.Marker({
        position: { lat: {{ branch.lat }}, lng: {{ branch.lon }} },
        map: map{{ forloop.counter }},
        title: "{{ branch.name }}"
      });
      {% endfor %}
    }
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC1RHlyqpClD4e6WQQLujLCndKe5ab2n9k&callback=initMap">
  </script>
</head>
<body>
  

  <h2>Company Branch Locations</h2>
  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
   <a href="{% url 'dashboard' %}" class="btn btn-outline-primary shadow-sm fw-semibold">← Dashboard</a>

    <div>
      <a href="{% url 'assign-branch-location' %}" class="btn btn-primary add-btn">+ Assign Employees</a>
      <a href="{% url 'add_branch_location' %}" class="btn btn-primary add-btn">+ Add Branch</a></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Radius (m)</th>
        <th>Map</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for branch in branches %}
      <tr>
        <td>{{ branch.name }}</td>
        <td>{{ branch.lat }}</td>
        <td>{{ branch.lon }}</td>
        <td>{{ branch.radius }}</td>
        <td>
          <div id="map{{ forloop.counter }}" class="map-preview" style="cursor:pointer; aspect-ratio: 1/1;"
            onclick="window.open('https://www.google.com/maps?q={{ branch.lat }},{{ branch.lon }}', '_blank')">
          </div>
        </td>
        <td>
          <a href="{% url 'edit_branch_location' branch.id %}" class="btn btn-edit">Edit</a>
          <button class="btn btn-danger delete-btn" data-id="{{ branch.id }}">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
 <!-- js -->
</body>
<!-- Delete Confirmation Modal -->
<div id="confirmModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h3>Confirm Deletion</h3>
    <p>Are you sure you want to delete this branch location? This action cannot be undone.</p>
    <div class="modal-actions">
      <button id="confirmDelete" class="btn btn-danger">Yes, Delete</button>
      <button id="cancelDelete" class="btn btn-cancel">Cancel</button>
    </div>
  </div>
</div>
<!-- Styles -->
<style>
  .modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(3px);
  }

  .modal-content {
    background-color: #fff;
    padding: 30px 25px;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    width: 90%;
    text-align: center;
    font-family: "Segoe UI", sans-serif;
  }

  .modal-content h3 {
    margin-top: 0;
    font-size: 1.25rem;
    color: #333;
  }

  .modal-content p {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 20px;
  }

  .modal-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .btn {
    padding: 8px 18px;
    font-size: 0.9rem;
    font-weight: 500;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .btn-danger {
    background-color: #e53935;
    color: #fff;
  }

  .btn-danger:hover {
    background-color: #c62828;
  }

  .btn-cancel {
    background-color: #e0e0e0;
    color: #333;
  }

  .btn-cancel:hover {
    background-color: #ccc;
  }
</style>

<script>
  // Get CSRF token from the form
  function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  let selectedId = null;

  // Attach click listener to all delete buttons
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        selectedId = this.dataset.id;
        document.getElementById('confirmModal').style.display = 'flex';
      });
    });

    // Cancel delete button
    document.getElementById('cancelDelete').addEventListener('click', function () {
      document.getElementById('confirmModal').style.display = 'none';
    });

    // Confirm delete button
    document.getElementById('confirmDelete').addEventListener('click', function () {
      fetch("{% url 'delete_branch_location' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({ id: selectedId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          window.location.reload();  // Or remove row directly if needed
        } else {
          alert(data.message);
        }
        document.getElementById('confirmModal').style.display = 'none';
      })
      .catch(err => {
        alert("❌ Something went wrong.");
        console.error(err);
        document.getElementById('confirmModal').style.display = 'none';
      });
    });
  });
</script>

</html>