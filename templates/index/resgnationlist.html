<!DOCTYPE html>
<html>
{% load static %}

<head>
  <!-- Basic Page Info -->
  <meta charset="utf-8">
  <title>HRMS</title>
  <link rel="icon" href="/static/logo/apple-touch-icon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- Mobile Specific Metas -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- AG Grid CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.2/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.2/styles/ag-theme-alpine.css">

  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="static/index/vendors/styles/core.css">
  <link rel="stylesheet" type="text/css" href="static/index/vendors/styles/icon-font.min.css">
  <link rel="stylesheet" type="text/css" href="static/index/src/plugins/jquery-steps/jquery.steps.css">
  <link rel="stylesheet" type="text/css" href="static/index/vendors/styles/style.css">

  <!-- Custom CSS for Grid -->
  <style>
  /* Ensure grid container is visible and responsive */
  .ag-theme-alpine {
    width: 100%;
    height: 500px;
  }

  /* Consistent cell styling */
  .ag-cell {
    display: flex;
    align-items: center; /* Vertically center content where applicable */
    padding: 5px;
    line-height: 1.2;
    white-space: normal !important; /* Allow wrapping by default */
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Customize Resignation Letter column to allow wrapping and taller height */
  .ag-theme-alpine .ag-cell[data-col-id="resignationLetter"] {
    white-space: normal !important; /* Allow text wrapping */
    text-overflow: clip; /* Avoid ellipsis for wrapped text */
    overflow: visible; /* Ensure all text is visible */
    height: auto !important; /* Allow cell to expand with content */
    padding: 10px; /* Increase padding for readability */
    line-height: 1.5; /* Improve readability of wrapped text */
  }

  /* Standardize buttons and badges */
  .action-buttons {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    padding: 5px 0;
  }

  .action-buttons .btn,
  .toggle-edit-form .btn,
  .ag-cell .badge {
    height: 28px; /* Match btn-sm height */
    line-height: 1.5; /* Ensure text is centered */
    padding: 0 8px; /* Consistent padding */
    font-size: 0.875rem; /* Match btn-sm font size */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px; /* Match btn-sm border-radius */
  }

  /* Ensure parent container doesnâ€™t hide grid */
  .table-responsive {
    overflow-x: auto;
  }

  .pd-20.card-box {
    padding: 20px;
    margin-bottom: 0;
  }
  .ag-header {
           
            color: #000;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }

        .ag-header-cell {
            
            color: #000;
            padding: 10px 8px;
        }

      
</style>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-119386393-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-119386393-1');
  </script>
  <script>
    flatpickr("[data-behavior='flatpickr']", {
      allowInput: true,
      dateFormat: "Y-m-d"
    });
  </script>
</head>

<body>
  <div class="mainSideBarFlex">
     <div class="left-side-bar">
        <div class="headBlockMain">
            <div  class="bgSecMainall">
    <div class="profileIconDiv">
        <div  class="profileImgWrapper">
            <img src="/media/school-logo.png" alt="" >
        
        </div>
        <div  class="profiletxt">
            <span  class="head-name">Edship Technologies</span>
            <p  class="sub-head">Transport Dashboard</p>
        </div></div><div  class="school-info">
            <div  class="flex-container">
                <div class="schoolInfoImgWrapper">
                    <img  src="/media/school-image.png" alt="School Logo" class="logo">
                </div><div  class="schooolInfoDetails">
                    <h2>Public School</h2>
                    <div  class="location">
                        <i  class="bi bi-geo-alt"></i>
                        <span >Kaloor, Kochi</span></div></div></div></div></div>
        </div>

      
       <div class="menu-block customscroll">
            <div class="sidebar-menu">
               <ul id="accordion-menu">
					
			
			
					<li>
						<a  href="{% url 'personalinfonav' %}" class="dropdown-toggle no-arrow active">
                          
                                	<span class="micon dw dw-user1"></span>
                                    <span class="mtext">My Profile</span>
                    
						
						</a>
					</li>
					<li>
						<a href="{% url 'leave' %}" class="dropdown-toggle no-arrow">
							<span class="micon dw dw-calendar-1"></span>
                            <span class="mtext">Leave</span>
						</a>
					</li>
					<li>
						<a href="{% url 'directory' %}" class="dropdown-toggle no-arrow">
							<span class="micon dw dw-list"></span>
                            <span class="mtext">Directory</span>
						</a>
					</li>
					<li>
						<a href="{% url 'dailylog' %}" class="dropdown-toggle no-arrow">
							<span class="micon bi bi-check2-square"></span>
                            <span class="mtext">Attendance</span>
						</a>
					</li>
					<li>
						<a href="{% url 'calender' %}" class="dropdown-toggle no-arrow">
							<span class="micon dw dw-calendar"></span>
                            <span class="mtext">Holiday Calendar</span>
						</a>
					</li>
					<li>
						<a href="{% url 'runpayroll_overview' %}" class="dropdown-toggle no-arrow">
							<span class="micon dw dw-money-2"></span>
                            <span class="mtext">Payroll</span>
						</a>
					</li>


				</ul>
            </div>
        </div>
    </div>





  <div class="main-container">
        <div class="header">
        <div class="header-left">
            <div class="menu-icon dw dw-menu"></div>
            
        </div>
        <div class="header-right">
            <div class="dashboard-setting user-notification">
                <div class="dropdown">
                    <a class="dropdown-toggle no-arrow" href="javascript:;" data-toggle="right-sidebar">
                        
                    </a>
                </div>
            </div>
          
            <div class="user-info-dropdown">
                <div class="dropdown">
                    <a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                        <span class="user-icon">
                         
                            {% if myprofile.image %}
                            <img src="{{ myprofile.image.url }}" alt="" >
                            {% else %}
                            <img src="/static/logo/userlogo.png" id="photo" >
                            {% endif %} 
                        </span>
                        <span class="user-name">{{request.user.username}}</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
                        <a class="dropdown-item" href="{% url 'createpersonalinfo' %}"><i class="dw dw-user1"></i> Profile</a>
                        <a class="dropdown-item" href="{% url 'department' %}" data-toggle="right-sidebar"><i class="dw dw-settings2"></i> Settings</a>
                        <a class="dropdown-item" href="{% url 'help_page' %}"><i class="dw dw-help"></i> Help</a>
                        <a class="dropdown-item" href="{% url 'logout' %}"><i class="dw dw-logout"></i> Logout</a>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    <div class="card-box educationHedaer">
      <ul class="nav nav-tabs customtab" role="tablist">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'personalinfonav' %}">Personal</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'worknav' %}">Work</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'view_team' request.user.id %}">Team</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'educationnav' %}">Education</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'familynav' %}">Family</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'documentsnav' %}">Document</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'workweeknav' %}">Work Week</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'pay_slip' %}">Payroll</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="{% url 'e_exit' %}">E-Exit</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'filemanagernav' %}">File Manager</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'list_generated_certificates' %}">Experience Certificates</a>
        </li>
      </ul>
      <div class="min-height-100px">
        <ul class="nav nav-tabs customtab" role="tablist">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'e_exit' %}">E-Exit</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="{% url 'resignationlist' %}">Resignation Applied</a>
          </li>
        </ul>
      </div>
<div class="scrollMainAllWidth">
   <div class="pd-20 card-box mb-30" style="margin-bottom: 0;">
        <div class="table-responsive">
          <!-- AG Grid Container -->
          <div id="resignationGrid" class="ag-theme-alpine" style="height: 500px; width: 100%;"></div>

          {% if not resg_list %}
          <hr>
          <p style="text-align:center;">No Data Found</p>
          {% endif %}

          <!-- Rejection Modal -->
          <div id="rejection-modal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog">
              <form id="rejection-form" method="post">
                {% csrf_token %}
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Reject Resignation</h5>
                  </div>
                  <div class="modal-body">
                    <input type="hidden" name="resg_id" id="resg-id">
                    <textarea name="rejection_reason" id="rejection-reason" class="form-control" placeholder="Enter rejection reason" required></textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Submit</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
</div>
     
    </div>
  </div>
    </div>

  {% for i in resg_list %}
  <div class="modal fade" id="updateResignationModal{{ i.id }}" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
      <form method="POST" action="{% url 'update_resignation_details' i.id %}">
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Update Resignation - {{ i.user.username }}</h5>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <label>Resignation Date</label>
                <input type="date" name="resignation_date" class="form-control" value="{{ i.resignation_date|date:'Y-m-d' }}" required>
              </div>
              <div class="col-md-6">
                <label>Last Working Day Requested</label>
                <input type="date" name="last_workingday" class="form-control" value="{{ i.last_workingday|date:'Y-m-d' }}" required>
              </div>
              <div class="col-md-6">
                <label>Actual Last Working Day</label>
                <input type="date" name="actual_last_working_day" class="form-control" value="{{ i.actual_last_working_day|date:'Y-m-d' }}" required>
              </div>
              <div class="col-md-6">
                <label>Notice Period</label>
                <input type="number" name="notice_period" class="form-control" value="{{ i.notice_period }}">
              </div>
              <div class="col-md-6">
                <label>Shortfall/Excess</label>
                <input type="number" name="Shortfall" class="form-control" value="{{ i.Shortfall }}">
              </div>
              <div class="col-md-12">
                <label></label>
                <select class="custom-select form-control" aria-placeholder="Reason for Leaving" name="reason" required>
                  <option value="" selected>Select Reason</option>
                  <option value="Resignation" {% if i.reason == 'Resignation' %}selected{% endif %}>Resignation</option>
                  <option value="Retirement" {% if i.reason == 'Retirement' %}selected{% endif %}>Retirement</option>
                  <option value="End of Contract" {% if i.reason == 'End of Contract' %}selected{% endif %}>End of Contract</option>
                  <option value="Voluntary Separation" {% if i.reason == 'Voluntary Separation' %}selected{% endif %}>Voluntary Separation</option>
                  <option value="Termination" {% if i.reason == 'Termination' %}selected{% endif %}>Termination</option>
                  <option value="Layoff" {% if i.reason == 'Layoff' %}selected{% endif %}>Layoff</option>
                  <option value="Relocation" {% if i.reason == 'Relocation' %}selected{% endif %}>Relocation</option>
                  <option value="Career Change" {% if i.reason == 'Career Change' %}selected{% endif %}>Career Change</option>
                  <option value="Personal Reasons" {% if i.reason == 'Personal Reasons' %}selected{% endif %}>Personal Reasons</option>
                  <option value="Promotion/Internal Transfer" {% if i.reason == 'Promotion/Internal Transfer' %}selected{% endif %}>Promotion/Internal Transfer</option>
                  <option value="Higher Education Pursuit" {% if i.reason == 'Higher Education Pursuit' %}selected{% endif %}>Higher Education Pursuit</option>
                  <option value="Health Issues" {% if i.reason == 'Health Issues' %}selected{% endif %}>Health Issues</option>
                  <option value="Family Responsibilities" {% if i.reason == 'Family Responsibilities' %}selected{% endif %}>Family Responsibilities</option>
                  <option value="Company Restructuring" {% if i.reason == 'Company Restructuring' %}selected{% endif %}>Company Restructuring</option>
                  <option value="Dissatisfaction with the Work Environment" {% if i.reason == 'Dissatisfaction with the Work Environment' %}selected{% endif %}>Dissatisfaction with the Work Environment</option>
                  <option value="Unfulfilled Growth Opportunities" {% if i.reason == 'Unfulfilled Growth Opportunities' %}selected{% endif %}>Unfulfilled Growth Opportunities</option>
                  <option value="Change in the Job Market" {% if i.reason == 'Change in the Job Market' %}selected{% endif %}>Change in the Job Market</option>
                  <option value="Entrepreneurship/Starting Own Business" {% if i.reason == 'Entrepreneurship/Starting Own Business' %}selected{% endif %}>Entrepreneurship/Starting Own Business</option>
                  <option value="Job Redundancy" {% if i.reason == 'Job Redundancy' %}selected{% endif %}>Job Redundancy</option>
                  <option value="End of Project/Contract Completion" {% if i.reason == 'End of Project/Contract Completion' %}selected{% endif %}>End of Project/Contract Completion</option>
                  <option value="Others" {% if i.reason == 'Others' %}selected{% endif %}>Others</option>
                </select>
              </div>
              <div class="col-md-12">
                <textarea name="resignation_letter" placeholder="Resignation Letter" readonly class="form-control" rows="3">{{ i.resignation_letter }}</textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Update</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}

  <!-- AG Grid JS -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.2/dist/ag-grid-community.min.js"></script>

  <!-- Other JS -->
  <script src="{% static 'js/resignation-status.js' %}"></script>
  <script src="static/index/vendors/scripts/core.js"></script>
  <script src="static/index/vendors/scripts/script.min.js"></script>
  <script src="static/index/vendors/scripts/process.js"></script>
  <script src="static/index/vendors/scripts/layout-settings.js"></script>
  <script src="static/index/src/plugins/jquery-steps/jquery.steps.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // AG Grid Column Definitions
    const columnDefs = [
  { 
    headerName: "#", 
    field: "index", 
    width: 100, 
    minWidth: 80, 
    valueGetter: params => params.node.rowIndex + 1 
  },
  {
    headerName: "Employee Name",
    field: "employeeName",
    width: 200,
    minWidth: 150,
    wrapText: true,
    cellRenderer: params => {
      return `<a href="{% url 'view_personalinfo' 0 %}".replace('0', params.data.id)>${params.value}</a>`;
    }
  },
  { 
    headerName: "Reason", 
    field: "reason", 
    width: 250,
    minWidth: 200,
    wrapText: true 
  },
  { 
    headerName: "Resignation Date", 
    field: "resignationDate", 
    width: 180,
    minWidth: 150 
  },
  {
    headerName: "Actual Last Working Day",
    field: "actualLastWorkingDay",
    width: 180,
    minWidth: 150,
    cellRenderer: params => params.value ? params.value : '<span class="text-muted">N/A</span>'
  },
  { 
    headerName: "Requested Last Working Day", 
    field: "lastWorkingDay", 
    width: 180,
    minWidth: 150 
  },
  { 
    headerName: "Shortfall/Excess", 
    field: "shortfall", 
    width: 140,
    minWidth: 120 
  },
  { 
    headerName: "Resignation Letter", 
    field: "resignationLetter", 
    width: 900,
    minWidth: 600,
    wrapText: true, // Enable text wrapping
    autoHeight: true // Allow row height to adjust to content
  },
  {
    headerName: "Actions",
    field: "actions",
    width: 300,
    minWidth: 250,
    cellRenderer: params => {
      if (params.data.status === 'Pending') {
        return `
          <div class="action-buttons">
            <button type="button" class="btn btn-sm btn-info me-2" data-bs-toggle="modal" data-bs-target="#updateResignationModal${params.data.id}">Update</button>
            <a href="#" class="reject-link" data-resg-id="${params.data.id}">
              <button class="btn btn-danger btn-sm">Reject</button>
            </a>
          </div>`;
      } else {
        return `
          <div class="action-buttons">
            <form class="revert-form d-inline">
              {% csrf_token %}
              <input type="hidden" name="resg_id" value="${params.data.id}">
              <button type="submit" class="btn btn-sm btn-warning">Revert</button>
            </form>
          </div>`;
      }
    }
  },
  {
    headerName: "Status",
    field: "status",
    width: 140,
    minWidth: 120,
    cellRenderer: params => {
      let badgeClass, badgeText;
      if (params.value === 'Approved') {
        badgeClass = 'bg-success text-white';
        badgeText = 'Approved';
      } else if (params.value === 'Rejected') {
        badgeClass = 'bg-danger text-white';
        badgeText = 'Rejected';
      } else {
        badgeClass = 'bg-warning text-dark';
        badgeText = 'Pending';
      }
      return `
        <div class="action-buttons">
          <span class="badge ${badgeClass}">${badgeText}</span>
        </div>`;
    }
  },
  {
    headerName: "Edit Access",
    field: "allowEdit",
    width: 180,
    minWidth: 150,
    cellRenderer: params => {
      return `
        <form method="post" class="toggle-edit-form">
          {% csrf_token %}
          <input type="hidden" name="resignation_id" value="${params.data.id}">
          <button type="submit" class="btn btn-sm ${params.value ? 'btn-danger' : 'btn-outline-info'}">
            ${params.value ? 'Disable' : 'Allow'}
          </button>
        </form>`;
    }
  }
];

    // AG Grid Row Data
    const rowData = [
      {% for i in resg_list %}
      {
        id: {{ i.id }},
        employeeName: "{{ i.user.username|escapejs }}",
        reason: "{{ i.reason|escapejs }}",
        resignationDate: "{{ i.resignation_date }}",
        actualLastWorkingDay: {% if i.actual_last_working_day %}"{{ i.actual_last_working_day|date:'Y-m-d' }}"{% else %}null{% endif %},
        lastWorkingDay: "{{ i.last_workingday }}",
        shortfall: {{ i.Shortfall|default:0 }},
        resignationLetter: "{{ i.resignation_letter|escapejs }}",
        status: "{{ i.status|escapejs }}",
        allowEdit: {{ i.allow_edit|yesno:"true,false" }}
      },
      {% endfor %}
    ];

    // AG Grid Options
   const gridOptions = {
  columnDefs: columnDefs,
  rowData: rowData,
  pagination: true,
  paginationPageSize: 10,
  domLayout: 'normal',
  // Remove fixed rowHeight to allow autoHeight to work
  defaultColDef: {
    sortable: true,
    filter: true,
    resizable: true,
    wrapText: true,
    autoHeight: true // Enable auto-height for all cells
  },
  onGridReady: params => {
    console.log('AG Grid is ready');
    params.api.sizeColumnsToFit(); // Fit columns to container width
  },
  onFirstDataRendered: params => {
    console.log('Data rendered in AG Grid:', params.api.getRowNodeIds().length, 'rows');
  }
};

    // Initialize AG Grid
    document.addEventListener('DOMContentLoaded', () => {
      const gridDiv = document.querySelector('#resignationGrid');
      if (!gridDiv) {
        console.error('Grid container #resignationGrid not found');
        return;
      }
      try {
        console.log('Initializing AG Grid with', rowData.length, 'rows');
        const grid = agGrid.createGrid(gridDiv, gridOptions);
      } catch (error) {
        console.error('Error initializing AG Grid:', error);
      }
    });

    // Toggle Edit Permission
    document.addEventListener('DOMContentLoaded', () => {
      document.body.addEventListener('submit', function(e) {
        if (e.target.classList.contains('toggle-edit-form')) {
          e.preventDefault();
          const formData = new FormData(e.target);
          const csrfToken = formData.get('csrfmiddlewaretoken');
          fetch("{% url 'toggle_edit_permission' %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken
            },
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              location.reload();
            } else {
              alert("Error: " + data.message);
            }
          })
          .catch(error => {
            console.error('Fetch error:', error);
            alert("Error while processing request.");
          });
        }
      });
    });

    // Show Rejection Modal
    $(document).on('click', '.reject-link', function(e) {
      e.preventDefault();
      const resgId = $(this).data('resg-id');
      $('#resg-id').val(resgId);
      $('#rejection-modal').modal('show');
    });

    // Rejection Form Submit
    $('#rejection-form').on('submit', function(e) {
      e.preventDefault();
      const resgId = $('#resg-id').val();
      const reason = $('#rejection-reason').val();
      const csrfToken = $('[name=csrfmiddlewaretoken]').val();
      $.ajax({
        url: "{% url 'reject_resignation' %}",
        method: "POST",
        data: {
          resg_id: resgId,
          rejection_reason: reason,
          csrfmiddlewaretoken: csrfToken
        },
        success: function() {
          $('#rejection-modal').modal('hide');
          location.reload();
        },
        error: function() {
          alert("Rejection failed. Try again.");
        }
      });
    });

    // Revert Form Submit
    document.addEventListener('DOMContentLoaded', function() {
      document.body.addEventListener('submit', function(e) {
        if (e.target.classList.contains('revert-form')) {
          e.preventDefault();
          const formData = new FormData(e.target);
          const csrfToken = formData.get('csrfmiddlewaretoken');
          fetch("{% url 'cancel_resignation' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": csrfToken
            },
            body: formData
          })
          .then(res => res.json())
          .then(data => {
            if (data.status === 'success') {
              window.location.reload();
            } else {
              alert("Revert failed.");
            }
          })
          .catch(() => alert("Something went wrong."));
        }
      });
    });
  </script>
</body>
</html>