<!DOCTYPE html>
<html>
{% load static %}
<head>
    <!-- Basic Page Info -->
    <meta charset="utf-8">
    <title>HRMS</title>
    <link rel="icon" href="/static/logo/apple-touch-icon.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="shortcut icon" type="image/png" href="/static/login/images/cydezlogo.png">

    <!-- Site favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/index/vendors/images/apple-touch-icon.png">

    <!-- Mobile Specific Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/static/index/vendors/styles/core.css">
    <link rel="stylesheet" type="text/css" href="/static/index/vendors/styles/icon-font.min.css">
    <link rel="stylesheet" type="text/css" href="/static/index/vendors/styles/style.css">

    <!-- AG Grid CSS -->
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community@32.1.0/dist/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community@32.1.0/dist/styles/ag-theme-alpine.css">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-119386393-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-119386393-1');
    </script>
    <style>
        /* Ensure AG Grid fits the layout */
        .ag-theme-alpine {
            height: 500px;
            width: 100%;
            margin-bottom: 30px;
        }
        /* Style for employee images */
        .employee-image {
            max-width: 40px;
            max-height: 40px;
            object-fit: contain;
            border-radius: 50%;
            margin-right: 10px;
        }
        /* Adjust row height for better spacing */
        .ag-row {
            height: 80px !important;
            display: flex;
            align-items: center;
        }
        /* Center content in cells */
        .ag-cell {
            display: flex;
            align-items: center;
            padding: 5px;
        }
        /* Style for the view button */
        .view-btn {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .view-btn:hover {
            background-color: #0056b3;
        }
        /* Ensure pagination and entries info are below table */
        .dataTables_wrapper {
            display: block;
            width: 100%;
            clear: both;
        }
        .dataTables_info {
            margin-top: 20px;
            padding-left: 15px;
            float: left;
        }
        .dataTables_paginate {
            margin-top: 20px;
            padding-right: 15px;
            float: right;
        }
        /* Prevent table overflow */
        #DataTables_Table_3_wrapper {
            overflow-x: auto;
            padding-bottom: 20px;
        }
        /* Filter container styling */
        .filter-container {
            margin-bottom: 20px;
        }
        .filter-container select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-right: 10px;
            font-size: 14px;
        }
         .ag-header-cell {
            white-space: nowrap;
            text-align: left !important;
            background-color: #3f51b5;
        }
       

        .ag-header-cell:hover {
            background-color: #ffffff;
            color: rgb(13, 13, 13);
            border-right: 1px solid #5c6bc0;
            padding: 10px 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="menu-icon dw dw-menu"></div>
            <div class="search-toggle-icon dw dw-search2" data-toggle="header_search"></div>
            <div class="header-search">
                <form id="searchForm" onsubmit="return false;">
                    <div class="form-group mb-0">
                        <i class="dw dw-search2 search-icon"></i>
                        <input type="text" data-live-search="true" class="form-control search-input" name="search" {% if query is None %} placeholder="Search " {% else %} value="{{query}}" {% endif %} id="searchInput">
                        <span onclick="clearSearch();" style="position: absolute; margin-left: 470px; margin-top: -35px; cursor: pointer" id="cross">
                            <a href="{% url 'empdirectory' %}" style="color: grey;"></a>
                        </span>
                        <div class="dropdown">
                            <button class="btn-primary dropdown-toggle no-arrow" type="submit">
                                <i class="fa fa-search" style="color: white"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="header-right">
            <div class="user-info-dropdown">
                <div class="dropdown">
                    <a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                        <span class="user-icon">
                            {% if k.image %}
                            <img src="{{ k.image.url }}" alt="" style="width: 100%; height: 100%;">
                            {% else %}
                            <img src="/static/logo/userlogo.png" id="photo" style="width: 100%; height: 100%;">
                            {% endif %}
                        </span>
                        <span class="user-name">{{request.user.username}}</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
                        <a class="dropdown-item" href="{% url 'empcreatepersonalinfo' %}"><i class="dw dw-user1"></i> Profile</a>
                        <a class="dropdown-item" href="{% url 'logout' %}"><i class="dw dw-logout"></i> Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-sidebar"></div>

    <div class="left-side-bar">
        <div class="brand-logo mt-3">
            <a href="{% url 'directory' %}">
                {% if request.user.company_type %}
                {% if request.user.company_type.inverse_logo %}
                <img src="{{ request.user.company_type.inverse_logo.url }}" style="width: 100%; height: 100%;">
                {% else %}
                <img src="/static/logo/deskapp-logo-white.svg" alt="" class="light-logo">
                {% endif %}
                {% else %}
                <img src="/static/logo/deskapp-logo-white.svg" alt="" class="light-logo">
                {% endif %}
            </a>
            <div class="close-sidebar" data-toggle="left-sidebar-close">
                <i class="ion-close-round"></i>
            </div>
        </div><br>
        <div class="menu-block customscroll">
            <div class="sidebar-menu">
                <ul id="accordion-menu">
                    <li class="btn-primary active" style="background-color: black">
                        <a href="{% url 'empdash' %}" class="dropdown-toggle no-arrow">
                            <span class="micon dw dw-house-1"></span><span class="mtext"><b>Dashboard</b></span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'empoverview' %}" class="dropdown-toggle no-arrow">
                            <span class="micon dw dw-building"></span><span class="mtext"><b>Company Profile</b></span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'emppersonalinfonav' %}" class="dropdown-toggle no-arrow">
                            <span class="micon dw dw-user1"></span><span class="mtext"><b>My Profile</b></span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'empleave' %}" class="dropdown-toggle no-arrow">
                            <span class="micon dw dw-calendar-1"></span><span class="mtext"><b>Leave</b></span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'empdirectory' %}" class="dropdown-toggle no-arrow">
                            <span class="micon dw dw-list"></span><span class="mtext"><b>Directory</b></span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'empdailylog' %}" class="dropdown-toggle no-arrow">
                            <span class="micon bi bi-check2-square"></span><span class="mtext"><b>Attendance</b></span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'emp_calender' %}" class="dropdown-toggle no-arrow">
                            <span class="micon dw dw-calendar"></span><span class="mtext"><b>Holiday Calendar</b></span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="mobile-menu-overlay"></div>

    <div class="main-container">
        <div class="pd-20 card-box mb-30">
            <div class="clearfix mb-20">
                <div class="pull-left">
                    <h4 class="text-blue h4">Directory</h4>
                </div>
            </div>
            <div class="pb-20">
                <div id="DataTables_Table_3_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
                    <div class="row">
                        <div class="col-md-9">
                            <h6 class="float-left">Number Of Employees: {{count_user}}</h6>
                        </div>
                        <div class="col-md-12">
                            <!-- Filter Section -->
                          
                            <!-- AG Grid container -->
                            <div id="myGrid" class="ag-theme-alpine"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12 col-md-5">
                            <div class="dataTables_info" id="DataTables_Table_3_info" role="status" aria-live="polite">{{ datas.start_index }} - {{ datas.end_index }} of {{ datas.paginator.count }} entries</div>
                        </div>
                        <div class="col-sm-12 col-md-7">
                            <div class="dataTables_paginate paging_simple_numbers" id="DataTables_Table_0_paginate">
                                <ul class="pagination">
                                    {% if datas.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ datas.previous_page_number }}">< Previous</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link"><</a>
                                    </li>
                                    {% endif %}
                                    {% for i in datas.paginator.page_range %}
                                    {% if i <= datas.number|add:5 and i >= datas.number|add:-5 %}
                                    {% if datas.number == i %}
                                    <li class="page-item active">
                                        <a class="page-link" href="?page={{forloop.counter}}">{{forloop.counter}}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{forloop.counter}}">{{forloop.counter}}</a>
                                    </li>
                                    {% endif %}
                                    {% endif %}
                                    {% endfor %}
                                    {% if datas.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ datas.next_page_number }}">» ></a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled">
                                        <a class="page-link">></a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bs-example-modal-md" id="Medium-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myLargeModalLabel">View Details</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <tr>
                                <th width="35%">Emp Id</th>
                                <td id="empid"></td>
                            </tr>
                            <tr>
                                <th>Name</th>
                                <td id="username"></td>
                            </tr>
                            <tr>
                                <th>Email</th>
                                <td id="email"></td>
                            </tr>
                            <tr>
                                <th>Phone</th>
                                <td id="phone"></td>
                            </tr>
                            <tr>
                                <th scope="col">DOB</th>
                                <td id="dob"></td>
                            </tr>
                            <tr>
                                <th scope="col">Gender</th>
                                <td id="gender"></td>
                            </tr>
                            <tr>
                                <th scope="col">Emp Type</th>
                                <td id="emptype"></td>
                            </tr>
                            <tr>
                                <th scope="col">Status</th>
                                <td id="status"></td>
                            </tr>
                            <tr>
                                <th scope="col">Department</th>
                                <td id="department"></td>
                            </tr>
                            <tr>
                                <th scope="col">Sub Department</th>
                                <td id="subdepartment"></td>
                            </tr>
                            <tr>
                                <th scope="col">Designation</th>
                                <td id="designation"></td>
                            </tr>
                            <tr>
                                <th scope="col">Job title</th>
                                <td id="jobtitle"></td>
                            </tr>
                            <tr>
                                <th scope="col">Work Location</th>
                                <td id="wrklcn"></td>
                            </tr>
                            <tr>
                                <th scope="col">Manager</th>
                                <td id="reptmgr"></td>
                            </tr>
                            <tr>
                                <th scope="col">Company Type</th>
                                <td id="companytype"></td>
                            </tr>
                            <tr>
                                <th scope="col">Probation Period</th>
                                <td id="probperiod"></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="/static/index/vendors/scripts/core.js"></script>
    <script src="/static/index/vendors/scripts/script.min.js"></script>
    <script src="/static/index/vendors/scripts/process.js"></script>
    <script src="/static/index/vendors/scripts/layout-settings.js"></script>
    <script src="/static/index/src/plugins/apexcharts/apexcharts.min.js"></script>
    <script src="https://unpkg.com/ag-grid-community@32.1.0/dist/ag-grid-community.min.js"></script>
    <script>
        // Details function for modal
        function details(empid, username, email, phone, dob, gender, emptype, status, department, subdepartment, designation, jobtitle, wrklcn, reptmgr, companytype, probperiod) {
            document.getElementById('empid').innerHTML = empid || '';
            document.getElementById('username').innerHTML = username || '';
            document.getElementById('email').innerHTML = email || '';
            document.getElementById('phone').innerHTML = phone || '';
            document.getElementById('dob').innerHTML = dob || '';
            document.getElementById('gender').innerHTML = gender || '';
            document.getElementById('emptype').innerHTML = emptype || '';
            document.getElementById('status').innerHTML = status || '';
            document.getElementById('department').innerHTML = department || '';
            document.getElementById('subdepartment').innerHTML = subdepartment || '';
            document.getElementById('designation').innerHTML = designation || '';
            document.getElementById('jobtitle').innerHTML = jobtitle || '';
            document.getElementById('wrklcn').innerHTML = wrklcn || '';
            document.getElementById('reptmgr').innerHTML = reptmgr || '';
            document.getElementById('companytype').innerHTML = companytype || '';
            document.getElementById('probperiod').innerHTML = probperiod || '';
        }

        // AG Grid configuration
        const columnDefs = [
            { headerName: "Emp id", field: "empid", sortable: true, width: 120 },
            {
                headerName: "Name",
                field: "username",
                sortable: true,
                width: 200,
                cellRenderer: params => {
                    const imageUrl = params.data.image || '/static/logo/userlogo.png';
                    return `
                        <div class="d-flex align-items-center">
                            <div class="mr-2 user-icon">
                                <img src="${imageUrl}" alt="" class="employee-image">
                            </div>
                            <div>${params.value || ''}</div>
                        </div>`;
                }
            },
            { headerName: "Department", field: "department", sortable: true, width: 150 },
            { headerName: "Designation", field: "designation", sortable: true, width: 150 },
            { headerName: "Manager", field: "reptmgr", sortable: true, width: 150 },
            { headerName: "Email", field: "email", sortable: true, width: 200 },
            { headerName: "Phone", field: "phone", sortable: true, width: 150 },
            {
                headerName: "Signed in",
                field: "signed_in",
                sortable: true,
                width: 120,
                valueGetter: params => {
                    return params.data.is_authenticated ? 'Yes' : 'No';
                }
            },
            {
                headerName: "Action",
                field: "action",
                width: 100,
                sortable: false,
                cellRenderer: params => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <button class="view-btn" data-toggle="modal" data-target="#Medium-modal">
                            <i class="dw dw-eye"></i> View
                        </button>`;
                    const viewBtn = div.querySelector('.view-btn');
                    viewBtn.addEventListener('click', () => {
                        details(
                            params.data.empid || '',
                            params.data.username || '',
                            params.data.email || '',
                            params.data.phone || '',
                            params.data.dob || '',
                            params.data.gender || '',
                            params.data.emptype || '',
                            params.data.status || '',
                            params.data.department || '',
                            params.data.subdepartment || '',
                            params.data.designation || '',
                            params.data.jobtitle || '',
                            params.data.wrklcn || '',
                            params.data.reptmgr || '',
                            params.data.companytype || '',
                            params.data.probperiod || ''
                        );
                    });
                    return div;
                }
            }
        ];

        // Ensure rowData handles null/undefined values
        const rowData = [
            {% for i in datas %}
            {
                empid: "{{ i.empid|escapejs }}",
                username: "{{ i.username|escapejs }}",
                image: "{% if i.myprofile_set.all %}{% for myprofile in i.myprofile_set.all %}{% if myprofile.image %}{{ myprofile.image.url|escapejs }}{% endif %}{% endfor %}{% else %}/static/logo/userlogo.png{% endif %}",
                department: "{{ i.department.name|escapejs|default:'' }}",
                designation: "{{ i.designation.name|escapejs|default:'' }}",
                reptmgr: "{{ i.reptmgr.username|escapejs|default:'' }}",
                email: "{{ i.email|escapejs|default:'' }}",
                phone: "{{ i.phone|escapejs|default:'' }}",
                is_authenticated: {{ i.is_authenticated|lower }},
                dob: "{{ i.dob|escapejs|default:'' }}",
                gender: "{{ i.gender|escapejs|default:'' }}",
                emptype: "{% if i.emptype %}{{ i.emptype|escapejs }}{% else %}''{% endif %}",
                status: "{{ i.status|escapejs|default:'' }}",
                subdepartment: "{{ i.subdepartment.subname|escapejs|default:'' }}",
                jobtitle: "{{ i.jobtitle.name|escapejs|default:'' }}",
                wrklcn: "{{ i.wrklcn.location|escapejs|default:'' }}",
                companytype: "{{ i.company_type.type_of_company|escapejs|default:'' }}",
                probperiod: "{% if i.probperiod %}{{ i.probperiod|escapejs }}{% else %}''{% endif %}"
            },
            {% empty %}
            {% endfor %}
        ];

        const gridOptions = {
            columnDefs: columnDefs,
            rowData: rowData,
            domLayout: 'autoHeight',
            defaultColDef: {
                resizable: true,
                filter: true
                            
            },
            rowHeight: 80,
            pagination: true,
            suppressColumnVirtualisation: true,
            onGridReady: function(params) {
                params.api.sizeColumnsToFit();
                console.log("Grid initialized with", rowData.length, "rows");
            }
        };

        // Initialize grid
        const gridDiv = document.querySelector('#myGrid');
        if (gridDiv) {
            new agGrid.Grid(gridDiv, gridOptions);
        } else {
            console.error("Grid container #myGrid not found");
        }

        // Handle search form
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const searchValue = document.getElementById('searchInput').value;
            if (gridOptions.api) {
                gridOptions.api.setQuickFilter(searchValue);
                gridOptions.api.refreshCells();
            } else {
                console.error("Grid API not available");
            }
        });

        // Clear search input
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            if (gridOptions.api) {
                gridOptions.api.setQuickFilter('');
                gridOptions.api.refreshCells();
            } else {
                console.error("Grid API not available");
            }
        }

        // Real-time search filtering
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchValue = this.value;
            gridOptions.api.setQuickFilter(searchValue);
        });

        // Apply filters
        function applyFilters() {
            const departmentFilter = document.getElementById('departmentFilter').value;
            const designationFilter = document.getElementById('designationFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            gridOptions.api.setRowData(rowData.filter(row => {
                const departmentMatch = !departmentFilter || row.department === departmentFilter;
                const designationMatch = !designationFilter || row.designation === designationFilter;
                const statusMatch = !statusFilter || row.status === statusFilter;
                return departmentMatch && designationMatch && statusMatch;
            }));
        }
    </script>
</body>
</html>